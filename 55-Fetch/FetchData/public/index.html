<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Fecth</title>
		<style>
			html {
			  font-family: sans-serif;
			}
			
			ul {
			  list-style-type: none;	
			  display: flex;
			  flex-flow: column;
			  align-items: flex-start;
			}
			
			li {
			  margin-bottom: 10px;
			  background-color: pink;
			  font-size: 150%;
			  border-top: 3px solid pink;
			  border-bottom: 3px solid pink;
			  box-shadow: 5px 5px 5px rgba(0,0,0,0.7);
			}
			
			strong {
			  background-color: purple;
			  color: white;
			  padding: 0 8px;
			  border-top: 3px solid purple;
			  border-bottom: 3px solid purple;
			  text-shadow: 2px 2px 1px black;
			}
			.img{
				width: 400px;
				height: 300px;
				border:1px solid #c1c1c1;
			}
		</style>
	</head>
	<body>
<!-- 		<form action="/api/user" method='post'>
			<p>姓名:<input type="text" name='name' class='name'></p>
			<p>年龄:<input type="text" name='age' class='age'></p>
			<input type="submit">
		</form> -->
		
		<h3>Fetch 同域 使用 Post 请求数据 </h3>
		<p>姓名:<input type="text" name='name' class='name'></p>
		<p>年龄:<input type="text" name='age' class='age'></p>
		<button class="btn">提交</button>
		
		<h3>Fecth 同域 使用Get 请求数据</h3>
		<p>firstName: <input type="text" name='firstName' class='firstName'></p>
		<p>lastName: <input type="text" name='lastName' class='lastName'></p>
		<button class="button">提交</button>
		
		<h3>使用 fetch 上传文件</h3>
		<p>username: <input type="text" name='username' class='username'></p>
		<p>avatar: <input type="file" name='file' class='avatar'></p>
		<input type="submit" value='上传' class='submit'>
		
		
		<h4>使用 fetch 上传多文件</h4>
		<p>自拍：<input type="file" multiple class='images'></p>
		<input type="submit" class='please'>
		
		
		<h4>Fetch json example</h4>
		<ul class="list"></ul>
		
		
		<h4>Fetch blob example</h4>
		<div class="img"></div>
		
		<script>
			function _$(el){
				return document.querySelector(el);
			}
			_$('.btn').onclick = function(){
				let name = _$('.name').value;
				let age = _$('.age').value;
				const data = {name,age}
				console.log(data,params(data));
				fetch('http://localhost:3000/api/user',{
					method:'POST',
					credentials:"same-origin",
					headers:{
						'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'
					},
					body:params(data)
				})
				.then(res => res.json())
				.then(res => {
					console.log(res);
				})
			}
			
			function params(obj){
				var arr = [];
				for(let key in obj){
					arr.push(key,'=',obj[key],'&');
				}
				return arr.slice(0,arr.length-1).join('');
			}
			
			// get请求的参数在 url? 后面
			_$('.button').onclick = function() {
				let firstName = _$('.firstName').value;
				let lastName = _$('.lastName').value;
				
				fetch(`http://localhost:3000/api?firstName=${firstName}&lastName=${lastName}`,{
					method:'GET',
					headers:{
						'Content-Type':'text/html'
					},
					credentials:'same-origin',
				}).then(res => res.text())
				.then(res => {
					console.log(res);
				})
			}
			
			// post请求通过 formData 上传文件 
			_$('.submit').onclick = function(){
				const formData = new FormData();
				let username = _$('.username').value;
				let avatar = _$('.avatar').files[0];
				formData.append('username',username);
				formData.append('avatar',avatar);
				fetch(`http://localhost:3000/api/avatar`,{
					method:'POST',
					body:formData
				})
				.then(res => res.json())
				.then(res => {
					console.log(res);
				})
			}
			
			
			// post 请求 通过 formData 上传多文件
			_$('.please').onclick = function(){
				const formData = new FormData();
				const files = _$('.images').files;
				for(let i = 0; i < files.length; i++){
					formData.append(`files-${i}`,files[i]);
				}
				fetch(`http://localhost:3000/api/image`,{
					method:'POST',
					body:formData,
				}).then(res => res.json())
				.then(res => {
					console.log(res);
				})
			}
			
			const myList = document.querySelector('ul');
			const myInit = {
				method:'GET',
			}
			const myRequest = new Request('http://localhost:3000/api/product',myInit);
			fetch(myRequest).then(res => res.json()).then(res=>{
				const products = res.data.products;
				for(let i = 0; i < products.length; i++){
					var listItem = document.createElement('li');
					listItem.innerHTML = `<strong>
							${products[i].Name} can be found in ${products[i].Location} 
						</strong>
						<strong>$ ${products[i].Price}</strong>
						`
					myList.appendChild(listItem);
				}
			})
			
			fetch('http://localhost:3000/api/blob',{
				headers:{
					'Content-Type':'application/x-www-form-urlencoded',
				},
				method:'GET',
				responseType:'blob'
			})
			.then(res => res.blob())
			.then(data => {
				const url = window.URL.createObjectURL(data);
				console.log(url);
				const oImg = document.createElement('img');
				oImg.src = url;
				_$('.img').appendChild(oImg);
				oImg.onload = function(){
					window.URL.revokeObjectURL(url);
				}
			})
			
			
			// fetch 请求是否携带cookie;
			fetch(`http://localhost:3000/api/cookie`,{
				method:'GET',
				credentials:'include',
				mode:'same-origin'
			})
			.then(res => res.json())
			.then(data => {
				console.log(data);
			})
		</script>
	</body>
</html>
