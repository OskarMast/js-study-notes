<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>绘制音频图</title>
    <style>
        body,html{
            overflow:hidden;
        }
        body,ul,ol{
            padding: 0;
            margin: 0;
        }
        ul,ol{
            list-style:none;
        }
        input{
            outline:none;
        }
        .container{
            position:absolute;
            top:0;
            z-index:100;
            width:360px;
            left:50%;
            transform:translateX(-50%);
        }
        input[type="text"]{
            width:300px;
            height:20px;
        }
        .list{
            width:304px;
            height:auto;
            background-color:rgba(255,255,255,.3);
        }
        .list>li{
            width:100%;
            overflow:hidden;
            white-space:nowrap;
            text-overflow:ellipsis;
            height:30px;
            cursor:pointer;
            text-align:left;
            font-size:14px;
            line-height:30px;
        }
        #canvas{
            display:block;
            background-image:linear-gradient(135deg,pink 0%,rgb(133,124,100) 100%);
        }
    </style>
</head>
<body>
<div class="container">
    <input type="text" class="keywords" placeholder="请输入歌曲/歌手">
    <input type="button" value="搜索" class="search">
    <ul class="list"></ul>
</div>
<canvas id="canvas"></canvas>
<audio src="./green.mp3"></audio>
<script>
    function _$(ele){
        return document.querySelector(ele);
    }
    _$(".search").addEventListener("click",function(event){
        _$(".list").innerHTML = "";
        _$(".list").style.display = "block";
        event = event || window.event;
        event.stopPropagation();
        let keywords = _$(".keywords").value;
        if(keywords.length){
            fetch(`https://api.wulv5.com/music/search?keywords=${keywords}`)
            .then((response) => response.json())
            .then((data)=>{
                let result = data.result.songs;
                result.forEach((item)=>{
                    let oLi = document.createElement("li");
                    oLi.innerText = `${item.name}`;
                    _$(".list").appendChild(oLi);
                    oLi.addEventListener("click",()=>{
                        fetch(`https://api.wulv5.com/music/song/url?id=${item.id}`)
                        .then(response => response.json())
                        .then(data=>{
                            _$("audio").src = data.data[0].url;
                            _$("audio").play();
                            _$(".list").style.display = "none";
                        });
                    },false);
                })
            })
        }
    },false);
    /*    Web Audio API
          音频可视化,特效，空间效果
          可视化原理:
            1. 音频上下文
    *
    * */
    // 获取audio元素
        const oAudio = document.querySelector("audio");
    // 创建音频上下文
        const oAudioContext = new AudioContext();
        // 创建媒体源
        const audioSrc = oAudioContext.createMediaElementSource(oAudio);
        // 创建分析机
        const analyser = oAudioContext.createAnalyser();
        // 将媒体源和分析机连接
        audioSrc.connect(analyser);
        // 将分析的结果与目标点连接起来
        analyser.connect(oAudioContext.destination);

        let oCanvas = document.getElementById("canvas");
        const ctx = oCanvas.getContext("2d");
        ~~(function(){
            window.onresize = arguments.callee;
            let [w,h] = [window.innerWidth,window.innerHeight];
            oCanvas.width = w;
            oCanvas.height = h;
            var lineargradient = ctx.createLinearGradient(w/2,h/2+100,w/2,h/2-100);
            lineargradient.addColorStop(0,'skyblue');
            lineargradient.addColorStop(.3,'seagreen');
            lineargradient.addColorStop(1,'red');
            let dataArray = new Uint8Array(analyser.frequencyBinCount);
            // 绘制80条
            let count = 60;
            function draw(){
                analyser.getByteFrequencyData(dataArray);
                // 绘制的步数,每隔多少步获取数据
                let step = Math.floor(dataArray.length/80);
                ctx.clearRect(0,0,w,h);
                for(let i = 0; i < count; i++){
                    let audioHeight = dataArray[step*i];
                    ctx.fillStyle = lineargradient;
                    ctx.fillRect(w/2 + (i * 9),h/2+100,7,-audioHeight);
                    ctx.fillRect(w/2 -(i * 9),h/2+100,7,-audioHeight);
                }
                window.requestAnimationFrame(draw);
            }
            draw();
            oAudio.play();
        })();
        oCanvas.addEventListener("click",function(){
            let state = oAudio.paused;
            switch(state){
                case true:
                    oAudio.play();
                    break;
                case false:
                    oAudio.pause();
                    break;
            }
        },false);

</script>
</body>
</html>