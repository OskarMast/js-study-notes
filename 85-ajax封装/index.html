<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>ajax封装</title>
	</head>
	<body>
		<script>
			/*
		   1. 请求的地址 url
		   2. 请求的数据参数 data
		   3. 同步请求还是异步请求 async：true/false 默认是异步
		   4. 请求的方法method GET POST
		   5. 请求成功后的回调函数 success
		   6. 请求失败后的回调函数 fail
			*/
		   function ajax(obj){
			   let xhr = new XMLHttpRequest();
			   if(!obj.async){
				   obj.async = true;
			   };
			   if(obj.method == "GET" && obj.data){
				   obj.url += params(obj.data);
			   };
			   xhr.open(obj.method,obj.url,obj.async);
			   if(obj.method == "POST"){
				   xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
				   xhr.send(params(obj.data));
			   }else{
				   xhr.send();
			   }
			   xhr.onreadystatechange = function(){
				   if(xhr.readyState == 4 && xhr.status == 200){
					   obj.success && obj.success(JSON.parse(xhr.responseText) );
				   }
			   }
		   }
			function ajax1(obj){
				let xhr = new XMLHttpRequest();
				if(!obj.async){
					obj.async = true;
				}
				if(obj.method == "GET"){
					obj.url += formData(obj.data);
					xhr.open(obj.method,obj.url,obj.async);
					xhr.send(null);
				}
				if(obj.method == "POST"){
					xhr.setRequestHeader("Content-Type","appliction/x-www-form-urlencoded");
					xhr.open(obj.method,obj.url,obj.async);
					xhr.send(formData(obj.data));
				}
				xhr.onreadystatechange = function(){
					if(xhr.readyState == 4 && xhr.status == 200){
						obj.success && obj.success( JSON.parse(xhr.responseText) );
					}
				}
		   }
		   let player = {
			   name:"kyrie",
			   age:26
		   }
		   function params(data){
			   let str = "?";
			   for(let key in data){
				   console.log(key,data[key]);
				   str+=key;
				   str+="=";
				   str+=data[key];
				   str+="&";
			   }
			   let newStr = str.substring(0,str.length-1);
			   return newStr;
		   }
		   function formData(data){
			   let [arr,str] = [[],"?"];
			   for(let [key,value] of Object.entries(data)){
				   arr.push(key,"=",value,"&");
			   }
			   arr.pop();
			   str += arr.join("");
			   return str;
		   }
		   
		   ajax1({
			   url:"https://api.wulv5.com/music/top/list",
			   method:"GET",
			   data:{
				   idx:14
			   },
			   success(data){
				   console.log(data);
			   }
		   });
		   
		   ajax({
			   url:"https://api.wulv5.com/music/personalized",
			   method:"GET",
			   success(data){
				   console.log(data);
			   }
		   });
		   
		   // 利用Promise 封装
		   function promiseAjax(obj){
			   let xhr = new XMLHttpRequest();
			   if(!obj.async){
				   obj.async = true;
			   }
			   if(obj.method.toLowerCase() == "get"){
				   obj.url += formData(obj.data);
				   xhr.open(obj.method,obj.url,obj.async);
			   }
			   if(obj.method.toLowerCase() == "post"){
				   xhr.open(obj.method,obj.url,obj.async);
				   xhr.setHeaderRequest("Content-Type","application/x-www-form-urlencoded");
				   xhr.send(formData(obj.data));
			   }else{
				   xhr.send(null);
			   }
				return new Promise(function(resolve,reject){
					xhr.onreadystatechange = function(){
						if(xhr.readyState == 4){
							if(xhr.status == 200){
								resolve(JSON.parse(xhr.responseText))
							}else{
								reject(xhr.status);
							}
						}
					}
				})
		   }
		   let p = promiseAjax({
			   url:"https://api.wulv5.com/music/artists",
			   method:"GET",
			   data:{
				   id:6452
			   }
		   });
			p.then(data => {
				console.log(data);
			}).catch(err=>{
				console.log(err);
			});
		</script>
	</body>
</html>
