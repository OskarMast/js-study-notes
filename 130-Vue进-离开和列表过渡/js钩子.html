<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JS钩子动画</title>
    <style>
        body,ul,ol{
            padding: 0;
            margin: 0;
        }
        ul{
            list-style:none;
        }
        .goods{
            position:absolute;
            left:300px;
            top:300px;
        }
        .cart{
            position:fixed;
            left:32px;
            bottom:22px;
            width:30px;
            height:30px;
            background-color:rgb(0,160,220);
            color:rgb(255,255,255);
            text-align:center;
            line-height:30px;
        }
        .ball{
            position:fixed;
            left:32px;
            bottom:22px;
            z-index:200;
            transition:all .4s cubic-bezier(0.49, -0.29, 0.75, 0.41);
        }
        .inner{
            width:16px;
            height:16px;
            border-radius:50%;
            background-color:rgb(0,160,220);
            transition:all .4s linear;
        }
    </style>
</head>
<body>
<div id="app">
    <ul class="goods">
        <li
            v-for="(item,index) in items"
            :key="index"
        >
            <span>{{item.text}}</span>
            <span>{{item.price}}</span>
            <button type="submit" @click="add">Add</button>
        </li>
    </ul>
    <div class="cart" ref="cart">{{count}}</div>
    <div class="ball-container">
        <div
            v-for="(ball,index) in balls"
            :key="index"
        >
            <transition
                name="drop"
                @before-enter="beforeEnter"
                @enter="enter"
                @after-enter="afterEnter"
            >
                <div class="ball" v-show="ball.show" ref="ball">
                    <div class="inner inner-hook"></div>
                </div>
            </transition>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
<script>
    const vm = new Vue({
        el:'#app',
        data:{
            count:0,
            items:[
                {text:'苹果',price:15},
                {text:'香蕉',price:15}
            ],
            balls:[
                {show:false},
                {show:false},
                {show:false},
                {show:false},
                {show:false}
            ],
            dropBalls:[]
        },
        methods:{
            add(event){
                this.drop(event.target);
            },
            drop(el){
            /* 遍历所有的小球,如果它是false，则修改为true，同时将点击的按钮 保存到 当前小球上
            *  将已经点击的小球添加进一个数组，方便后续回收
            * */
                for(let i = 0; i < this.balls.length; i++){
                    let ball = this.balls[i];
                    if(!ball.show){
                        ball.show = true;
                        ball.el = el;
                        this.dropBalls.push(ball);
                        return;
                    }
                }
            },
            beforeEnter(el){
                /*进入之前,遍历所有为true的小球,计算当前点击按钮 相对于落点 的位置*/
                let count = this.balls.length;
                while(count--){
                    let ball = this.balls[count];
                    if(ball.show){
                        let rect = ball.el.getBoundingClientRect();
                        let x = rect.left - 22;
                        let y = -(window.innerHeight - rect.top - 22);
                        el.style.webkitTransform = `translate3d(0,${y}px,0)`;
                        el.style.transform = `translate3d(0,${y}px,0)`;
                        let inner = el.getElementsByClassName('inner-hook')[0];
                        inner.style.webKitTransform = `translate3d(${x}px,0,0)`;
                        inner.style.transform = `translate3d(${x}px,0,0)`;
                    }
                }
            },
            enter(el){
            // 为何此处要触发浏览器重绘
                let rf = el.offsetHeight;
                this.$nextTick(() => {
                    el.style.webkitTransform = 'translate3d(0,0,0)';
                    el.style.transform = 'translate3d(0,0,0)';
                    let inner = el.getElementsByClassName('inner-hook')[0];
                    inner.style.webKitTransform = 'translate3d(0,0,0)';
                    inner.style.transform = 'translate3d(0,0,0)';
                })
            },
            afterEnter(el){
                let ball = this.dropBalls.shift();
                if(ball){
                    ball.show = false;
                    el.style.display = 'none';
                }
            },
        }
    })
</script>
</body>
</html>