<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>多文件上传</title>
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_859901_664zmb9gvpe.css">
    <style>
        body,ul,ol,p{
            padding: 0;
            margin: 0;
        }
        body{
            background-color:#ddd;
        }
        i,em{
            font-style:normal;
        }
        button{
            outline:none;
            border:none;
            display:inline-block;
        }
        ul,ol{
            list-style:none;
        }
        .container{
            margin:30px auto;
            width: 1000px;
            min-height:600px;
            height:auto;
            background-color:#fff;
            border-radius:8px;
        }
        .container h3.title{
            height:70px;
            line-height:70px;
            color:#98989b;
            text-align:center;
            font-size:24px;
            border-bottom:1px solid #f4f3f4;
        }
        .container>.select-area,.container .control,.container .content{
            padding:0 20px;
        }
        .container>.select-area,.container .control{
            display:flex;
            justify-content:space-between;
        }
        .container .select-box,.container .drag-box{
            height:160px;
            background-color:#f2f1f2;
        }
        .container .select-box{
            width:260px;
        }
        .container .drag-box{
            width: 680px;
            color:#a5a4a5;
            text-align:center;
            line-height:160px;
            user-select:none;
        }
        .container input[type='file']{
            display:none;
        }
        .container .select-box label{
            position:relative;
            display:block;
            width:100%;
            height:100%;
            background-color:#f2f1f2;
        }
        .container .text{
            position:absolute;
            width:100%;
            bottom:0;
            height:40px;
            text-align:center;
            line-height:40px;
            background-color:#65ae06;
            color:#e4fff5;
        }
        .container .control{
            height:90px;
            align-items:center;
        }
        .control label,.control .btns>span{
            display:inline-block;
            width: 130px;
            height:40px;
            text-align:center;
            line-height:40px;
            color:rgb(200,200,200);
            user-select:none;
            cursor:pointer;
        }
        .container label{
            background-color:#9f939f;
        }
        .control .btns>span{
            background-color:#65ae06;
        }
        .content>.list{
            width:960px;
            min-height:200px;
            height:auto;
            border:1px solid #ccc;
            display:flex;
            flex-flow:row wrap;
        }
        .content>.list li{
            position:relative;
            width:240px;
            height:240px;
        }
        .content>.list .delete{
            float:right;
            transform:translateX(-10px);
        }
        .content>.list .title{
            display:none;
            position:absolute;
            top:0;
            height:30px;
            width:100%;
            line-height:30px;
            font-size:14px;
            text-align:center;
            background-color:rgba(0,0,0,.5);
            color:#fff;
        }
        .content>.list li:hover .title{
            display:block;
        }
        .content>.list .delete:hover{
            color:#f00;
            cursor:pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="title">图片拖拽上传示范</h3>
        <section class="select-area">
            <div class="select-box">
                <label for="file">
                    <p class="text">选择图片</p>
                </label>
                <input type="file" id="file" multiple>
            </div>
            <div class="drag-box">请将图片拖到此区域</div>
        </section>
        <section class="control">
            <p class="info">
                <span>已选择 <i class="number">0</i> 张图片,</span>
                <span>共 <i class="size">0</i> MB </span>
            </p>
            <div class="btns">
                <label for="continue">继续选择</label>
                <input type="file" id="continue" multiple>
                <span class="update">开始上传</span>
            </div>
        </section>
        <section class="content">
            <ul class="list"></ul>
        </section>
    </div>
    <script>
        let _$ = (ele) => document.querySelector(ele);
        /*
        * 1. 点击文本框的时候会选择图片
        * 2. 定义全局变量保存文件信息 名字,大小以及
        * */
        let oInput = document.querySelectorAll("input[type='file']");
        let [arrName,size,files] = [[],[],[]];
        oInput.forEach((item) => {
            item.addEventListener("change",function(e){
                e = e || window.e;
                e.stopPropagation();
                if(this.value){
                    if(this.files.length){
                        for(let i = 0,item; item = this.files[i]; i++){
                            if(/image/.test(item.type)){
                                arrName.push(item.name);
                                size.push(item.size);
                                files.push(item);
                                showImage(item);
                            }
                        }
                    }
                    this.value = "";
                }
            },false);
        });
        // 封装一个函数对选择到的图片进行预览
        function showImage(file){
            let blob = new Blob([file],{type:'image/jpeg'});
            let url = window.URL.createObjectURL(blob);
            let li = document.createElement('li');
            li.innerHTML = `
                <p class="title"></p>
                <img src="${url}" width="100%" height="100%">
                `;
            _$(".list").appendChild(li);
            count();
        }
        // 对文件进行拖拽显示
        _$(".drag-box").addEventListener("dragover",drag,false);
        _$(".drag-box").addEventListener("dragenter",drag,false);
        _$(".drag-box").addEventListener("dragleave",drag,false);
        _$(".drag-box").addEventListener("drop",drag,false);

        function drag(e){
            e = e || window.e;
            e.preventDefault();
            let type = e.type;
            switch(type){
                case "dragenter":
                    this.innerText = "请释放鼠标";
                    break;
                case "drapleave":
                    this.innerText = "请将文件拖入此区域";
                    break;
                case "drop":
                    this.innerText = "请将文件拖入此区域"
                    let file = e.dataTransfer.files;
                    // 对拖入的文件进行判断
                    for(let i = 0 ,item;item = file[i]; i++){
                        if(/image/.test(item.type)){
                            arrName.push(item.name);
                            size.push(item.size);
                            files.push(item);
                            showImage(item);
                        }
                    }
                    break;
            }
        }
        // 计算图片的 大小,数量 以及显示图片名称等信息
        function count(){
            // 显示图片数量,即number数字的长度相加
            _$(".info .number").innerText = files.length;
            // 如果有长度则计算
            if(size.length){
                let totalSize = size.reduce( (prev,next) => prev+next ,0);
                _$(".info .size").innerText = ( totalSize/(Math.pow(1024,2) )).toFixed(2);
            }else{
                // 否则图片大小为0
                _$(".info .size").innerText = 0;
            }
            let aTitle = document.querySelectorAll(".list>li .title");
            aTitle.forEach(function(item,index){
                item.innerHTML = `<span>${arrName[index]}</span><i class="delete iconfont">&#xe61b;</i>`
            });
            dele();
        };
        // 点击删除图片
        function dele(){
            let aLi = document.querySelectorAll(".list>li");
            aLi.forEach((item,index)=>{
                item.addEventListener("click",function(e){
                    e = e || window.e;
                    if(e.target.tagName.toLowerCase() === "i"){
                        arrName.splice(index,1);
                        size.splice(index,1);
                        files.splice(index,1);
                        _$(".list").removeChild(aLi[index]);
                        count();
                    }
                },false);
/*                item.children[0].children[1].addEventListener("click",function(e){
                    e = e || window.e;
                    e.stopPropagation();
                    arrName.splice(index,1);
                    size.splice(index,1);
                    files.splice(index,1);
                    _$(".list").removeChild(aLi[index]);
                    count();
                },false);*/
            });
        };

        // 点击按钮开始上传图片
        _$(".update").onclick = function(){
            // 如果有数据的时候再发送请求
            if(files.length){
                files.forEach((item,index)=>{
                    let xhr = new XMLHttpRequest();
                    xhr.upload.onprogress = function(e){
                        console.log(e.loaded,e.total);
                    }
                    xhr.open("POST","http://localhost:63342",true);
                    let formData = new FormData();
                    formData.append("file"+index,item);
                    xhr.send(formData);
                    xhr.onreadystatechange = function(){
                        if(xhr.readyState == 4 && xhr.status == 200){
                            console.log(xhr.responseText);
                        }
                    }
                })

            }

        }

    </script>
</body>
</html>