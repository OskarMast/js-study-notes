<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>封装AJAX</title>
    <style>
        body,ul,ol,p{
            padding: 0;
            margin: 0;
        }
        ul,ol{
            list-style:none;
        }
        img{
            width: 300px;
            height:250px;
        }
        p.text{
            color:red;
        }
        .list>li{
            width: 300px;
            height: 300px;
        }
    </style>
</head>
<body>
    <ul class="list">
    </ul>
    <script src='./ajax.js'></script>
    <script>
        let oList = document.querySelector('.list');

        ajax({
            url:'http://h6.duchengjiu.top/shop/api_goods.php',
            method:'GET',
            data:{
                cat_id:'92',
                page:'1',
                pagesize:'20'
            },
            async:true,
            success:function(obj){
                data = JSON.parse(obj).data;
                let fragment = document.createDocumentFragment();
                data.forEach(function(item){
                    let aLi = document.createElement('li');
                    aLi.innerHTML = `
                    <a href='#'><img src='${item.goods_thumb}'></a>
                    <p class='text'>${item.goods_name}</p>
                    `;
                    fragment.appendChild(aLi);
                });
                oList.appendChild(fragment);
            }
        });        

        // 封装一个ajax简易库
        /*
        obj是一个对象,里面需要传入jax请求所需要的参数
        
        url:    请求的地址
        type:   请求的方法 GET POST
        data:   请求的数据
        async:  同步还是异步(true or false)
        success:请求成功时返回的函数
        */

        /*
        原生ajax的步骤:
        1. let xhr = new XMLHttpRequest();
                这里以GET请求,异步为例
        2. xhr.open('GET',url,true);
        3. xhr.send();
        4. xhr.onreadystatechange = function(){
            if(xhr.readyState == 4 && xhr.status == 200){
                console.log(xhr.responseText);
            }
        }
        */

        function myAjax(obj){
            // 先实例化ajax的XMLHttpRequest()对象
            let xhr = new XMLHttpRequest();
            if(obj.type.toLowerCase() == 'get' && obj.data){
                obj.url += params(obj.data);
            }
            if(!obj.async){
                obj.async = true;
            }
            xhr.open(obj.type,obj.url,obj.async);
            if(obj.type.toLowerCase() == 'post'){
                xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
                xhr.send(params(obj.data));
            }else{
                xhr.send();
            }
            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4 && xhr.status == 200){
                    obj.success && obj.success(JSON.parse(xhr.responseText));
                }
            }
        }

        function params(obj){
            let str = '?';
            for(let key in obj){
                str += key+'='+obj[key]+'&';
            }
            return str.replace(/&$/,'');
        }

        let player = {
            name:'kyrie',
            age:26,
            position:'guard'
        }
        let string = params(player);
        console.log(string);

        myAjax({
            url:'http://h6.duchengjiu.top/shop/api_goods.php',
            type:'GET',
            data:{
                cat_id:'92',
                page:2,
                pagesize:100,
            },
            success(data){
                console.log(data);
            }
        });


        function param(obj){
            let str = "?";
            for(let key in obj){
                str += key + '=' + obj[key] + "&";
            }
            return str.slice(0,str.length-1);
        }

        function Ajax(obj){
            let xhr = new XMLHttpRequest();
            if( obj.type.toLowerCase() == 'get' && obj.data){
                obj.url += param(obj.data);
                xhr.open(obj.type,obj.url,true);
                xhr.send();
            }else{
                xhr.open(obj.type,obj.url,true);
                xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
                xhr.send(param(obj.data));
            }
            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4 && xhr.status == 200){
                    obj.success && obj.success( JSON.parse(xhr.responseText) );
                }
            }
        }

        Ajax({
            url:'http://h6.duchengjiu.top/shop/api_goods.php',
            type:'GET',
            data:{
                cat_id:'92',
                page:2,
                pagesize:10,
            },
            success(data){
                console.log(data);
            }
        })



    </script>
</body>
</html>